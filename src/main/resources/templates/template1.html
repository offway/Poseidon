<!DOCTYPE html>
<html lang="en">
<head>
	<head th:replace="head"></head>
	<title>新加模板</title>
	<script src="https://unpkg.com/qiniu-js@2.5.3/dist/qiniu.min.js"></script>
	<link rel="stylesheet" href="assets/js/select2/select2.css"/>
	<link rel="stylesheet" href="assets/js/select2/select2-bootstrap.css"/>
	<link rel="stylesheet" href="assets/js/multiselect/css/multi-select.css"/>
</head>
<body class="hold-transition skin-black light-sidebar sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">
	<header th:replace="navbar"></header>
	<aside th:replace="sidebar-menu"></aside>
	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
		<!-- Content Header (Page header) -->
		<div class="content-header d-none d-md-block">
			<div class="d-flex align-items-center">
				<div class="mr-auto">
					<h3 class="page-title br-0">新加模板</h3>
				</div>
				<div class="right-title">
				</div>
			</div>
		</div>
	<section class="content">
		<div class="panel-body">
			<div class="row">
			<form role="form" id="saveForm" class="form-horizontal">
				<div class="form-group col-md-7">
					<label class="control-label">类型</label>
					<div class="radio">
						<input name="type" type="radio" id="type_1" checked="checked" value="0"/>
						<label for="type_1">重叠</label>
						<input name="type" type="radio" id="type_2" value="1"/>
						<label for="type_2">不重叠</label>
					</div>
				</div>
				<div class="form-group col-md-7">
					<label class="control-label">底图</label>
					<input type="file" id="imageUnderUrl" name="imageUnderFile" placeholder="底图" onchange="uploadMainFile(this,'0')"/>
					<img alt="" src="" name="imageUnder" style="display:none;" />
					<input type="hidden" class="form-control" name="imageUnderUrl" />
				</div>
				<div class="form-group col-md-7">
					<label class="control-label">文字图</label>
					<input type="file" id="imageTextUrl" name="imageTextFile" placeholder="文字图" onchange="uploadMainFile(this,'1')"/>
					<img alt="" src="" name="imageText" style="display:none;" />
					<input type="hidden" class="form-control" name="imageTextUrl" />
				</div>
				<div class="form-group col-md-7">
					<label class="control-label">滚动区域</label>
					<div class="radio">
						<input name="rollingType" type="radio" id="rollingType_1" checked="checked" onclick="rollingTypeRadio('0')"/>
						<label for="rollingType_1">图片</label>
						<input name="rollingType" type="radio" id="rollingType_2" onclick="rollingTypeRadio('1')"/>
						<label for="rollingType_2">文字</label>
					</div>
				</div>
				<div class="form-group col-md-7" id="rollingImageUrlDiv">
					<input type="file" name="rollingImageFile" placeholder="滚动区域图片" onchange="uploadMainFile(this,'2')"/>
					<img alt="" src="" id="rollingImage" name="rollingImage" style="display:none;" />
					<input type="hidden" class="form-control" id="rollingImageUrl" name="rollingImageUrl" />
				</div>
				<div class="form-group col-md-7" id="rollingTxt" style="display: none">
					<textarea class="form-control" rows="3" id="rollingText" name="rollingText"></textarea>
				</div>
				<div class="form-group col-md-7">
					<label class="control-label">解锁</label>
					<div class="radio">
						<input name="unlock" type="radio" id="unlock_1" value="1" checked="checked" onclick="unlockRadio('1')"/>
						<label for="unlock_1">开放</label>
						<input name="unlock" type="radio" id="unlock_2" value="0" onclick="unlockRadio('0')"/>
						<label for="unlock_2">解锁条件</label>
					</div>
				</div>
				<div class="form-group col-md-7" id="unlockText" style="display: none">
					<label class="control-label">订阅数</label>
					<input type="text" class="form-control" id="subscribeCount" name="subscribeCount"/>
					<label class="control-label">提示文字</label>
					<input type="text" class="form-control" id="promptText" name="promptText"/>
				</div>
				<div class="actions clearfix">
					<button type="button" class="btn btn-success save">保存</button>
				</div>
			</form>
			</div>
		</div>
	</section>
	</div>

	<footer th:replace="footer"></footer>
</div>

<script src="assets/js/datepicker/bootstrap-datepicker.js"></script>
<script src="assets/js/select2/select2.min.js"></script>
<script src="assets/js/multiselect/js/jquery.multi-select.js"></script>
<script th:inline="javascript">

	function unlockRadio(type) {
		if (type == "0"){
			$("#unlockText").show();
		}else {
			$("#unlockText").hide();
			$("#promptText").val("");
            $("#subscribeCount").val("");
		}
	}
	
	function rollingTypeRadio(type) {
		if (type == "0"){
			$("#rollingTxt").hide();
			$("#rollingImageUrlDiv").show();
			$("#rollingText").val("");
		}else {
			$("#rollingImageUrlDiv").hide();
			$("#rollingTxt").show();
			$("#rollingImage").attr("src", "");
			$("#rollingImageUrl").val("");
		}
	}

	function uploadMainFile(self,type) {
		var that = $(self);
		if (self.files.length > 0) {
			var file = self.files[0];
			getQNToken(function (token) {
				this.upload("", token, file, function () {
					//
				}, function (err) {
					console.log("error");
					console.log(err);
				}, function (res) {
					var url = qiniuUrl + "/" + res.key;
					if (type == "0"){
						that.parent().find("[name=imageUnderUrl]").val(url);
						that.parent().find("[name=imageUnder]").attr("src", url);
						that.parent().find("[name=imageUnder]").attr("width", "100px");
						that.parent().find("[name=imageUnder]").attr("height", "100px");
						that.parent().find("[name=imageUnder]").show();
					}else if (type == "1"){
						that.parent().find("[name=imageTextUrl]").val(url);
						that.parent().find("[name=imageText]").attr("src", url);
						that.parent().find("[name=imageText]").attr("width", "100px");
						that.parent().find("[name=imageText]").attr("height", "100px");
						that.parent().find("[name=imageText]").show();
					}else if (type == "2"){
						that.parent().find("[name=rollingImageUrl]").val(url);
						that.parent().find("[name=rollingImage]").attr("src", url);
						that.parent().find("[name=rollingImage]").attr("width", "100px");
						that.parent().find("[name=rollingImage]").attr("height", "100px");
						that.parent().find("[name=rollingImage]").show();
					}
				});
			});
		} else {
			confirm("未选择任何文件!");
		}
	}

	function upload(param, token, file, next, error, complete) {
		if (file == '') {
			complete('');
		} else {
			var filename = file.name;
			var postf = filename.substring(filename.lastIndexOf("."));

			var config = {
				useCdnDomain: true,
				region: qiniu.region.z0
			};
			var putExtra = {
				fname: "",
				params: {"x:param": param},
				mimeType: ["image/png", "image/jpeg", "image/gif"] || null
			};
			/* var observable = qiniu.upload(file, "image/wx/"+UUID.randomUUID()+postf, token,
                    putExtra, config); */
			var fname = filename.replace(postf, "");
			var observable = qiniu.upload(file, "image/wx/" + param + "/" + (new Date().getTime()) + postf, token,
					putExtra, config);
			var subscription = observable.subscribe(next, error, complete);
		}
	}

	function getQNToken(cb) {
		$.get("/qiniu/token", {}, function (token) {
			cb(token);
		});
	}
	var qiniuUrl = [[${qiniuUrl}]];
	/*<![CDATA[*/
	jQuery(document).ready(function ($) {
		$(".btn.btn-success.save").click(function () {

		});

		$(".btn.btn-info.add").click(function () {
			$("#saveForm").find("input[name='id']").val("");
			$.get("/roles-all", {}, function (data) {
				$('#multi-select').empty();
				$.each(data, function (i, e) {
					$('#multi-select').append("<option value=" + e.id + ">" + e.name + "</option>");
				});
				$("#multi-select").multiSelect({
					afterInit: function () {
						// Add alternative scrollbar to list
						// this.$selectableContainer.add(this.$selectionContainer).find('.ms-list').perfectScrollbar();
					},
					afterSelect: function () {
						// Update scrollbar size
						// this.$selectableContainer.add(this.$selectionContainer).find('.ms-list').perfectScrollbar('update');
					}
				});
				$('#multi-select').multiSelect('refresh');
				$("#multi-select1").multiSelect({
					afterInit: function () {
						// Add alternative scrollbar to list
						// this.$selectableContainer.add(this.$selectionContainer).find('.ms-list').perfectScrollbar();
					},
					afterSelect: function () {
						// Update scrollbar size
						// this.$selectableContainer.add(this.$selectionContainer).find('.ms-list').perfectScrollbar('update');
					}
				});
				$('#multi-select1').multiSelect('refresh');
				jQuery('#modal-6').modal('show', {backdrop: 'fade'});
			});
		});

		//保存
		$(".btn.btn-info.save").click(function () {
			var form = $("#saveForm");
			var username = form.find("input[name='username']").val();
			if (username == '') {
				toastr.error("用户名不能为空", "温馨提示");
				return;
			}
			var nickname = form.find("input[name='nickname']").val();
			if (nickname == '') {
				toastr.error("昵称不能为空", "温馨提示");
				return;
			}
			var id = form.find("input[name='id']").val();
			var brandIdsArray = $("#multi-select1").val();
			var brandIds = "";
			if (null != brandIdsArray) {
				$.each(brandIdsArray, function (i, e) {
					brandIds += e + ","
				});
			}
			$.post("/users-save", {
				id: id,
				username: username,
				nickname: nickname,
				roles: $("#multi-select").val(),
				brandIds: brandIds
			}, function (data) {
				if (data) {
					jQuery('#modal-6').modal('hide');
					toastr.success("操作已成功！", "温馨提示");
					oTable.fnDraw(oTable.fnSettings());
				} else {
					toastr.error("操作失败,请检查用户名是否存在", "温馨提示");
				}
			});
		});
	});
	/*]]>*/
</script>
</body>
</html>